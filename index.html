// === 配置区域 ===
    const PROJECT_URL = 'https://nmlzxbbwbquoedycfsee.supabase.co';
    const PROJECT_KEY = 'sb_publishable_YA7A9CBUpaYBdhm3UgLNVA_sZ9RjoZC';

    let labClient; 
    let allReagents = [];

    async function initSystem() {
        try {
            labClient = window.supabase.createClient(PROJECT_URL, PROJECT_KEY);
            
            // 1. 首次加载数据
            await fetchData();

            // 2. 开启实时监听：重点就在这里！
            setupRealtimeSubscription();

        } catch (err) {
            console.error("系统初始化错误:", err);
        }
    }

    // 获取所有数据的函数
    async function fetchData() {
        const { data, error } = await labClient
            .from('reagents')
            .select('*')
            .order('created_at', { ascending: false });

        if (!error) {
            allReagents = data;
            renderItems(allReagents);
        }
    }

    // 核心逻辑：订阅数据库变动
    function setupRealtimeSubscription() {
        labClient
            .channel('any-db-changes') // 创建一个频道
            .on(
                'postgres_changes', 
                { event: '*', schema: 'public', table: 'reagents' }, 
                (payload) => {
                    console.log('检测到云端变动:', payload);
                    // 无论谁添加、删除或修改了数据，所有人的网页都会触发 fetchData 重新同步
                    fetchData(); 
                }
            )
            .subscribe();
    }

    function renderItems(list) {
        const container = document.getElementById('results');
        document.getElementById('statsInfo').innerText = `共有 ${list.length} 种试剂`;
        container.innerHTML = '';
        list.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'reagent-card';
            div.innerHTML = `
                <div class="reagent-loc">${item.location}</div>
                <div class="reagent-name">${item.name}</div>
                <div class="reagent-cas">CAS号: ${item.cas || '--'}</div>
                <button class="btn-del" onclick="deleteReagent(${item.id})">删除试剂</button>
            `;
            container.appendChild(div);
        });
    }

    // 搜索、弹窗控制、添加、删除函数保持不变...
    // (为了简洁，这里省略重复的 UI 控制函数，请保留你原来的 addNew, deleteReagent, doSearch 等)

    function doSearch() {
        const key = document.getElementById('uiSearch').value.toLowerCase();
        const filtered = allReagents.filter(item => 
            (item.name||'').toLowerCase().includes(key) || 
            (item.location||'').toLowerCase().includes(key) || 
            (item.cas||'').includes(key)
        );
        renderItems(filtered);
    }

    function toggleModal(show) {
        document.getElementById('addModal').style.display = show ? 'block' : 'none';
        document.getElementById('overlay').style.display = show ? 'block' : 'none';
    }

    async function addNew() {
        const name = document.getElementById('newName').value.trim();
        const loc = document.getElementById('newLoc').value.trim();
        const cas = document.getElementById('newCas').value.trim();
        if(!name || !loc) return alert("名称和位置不能为空");
        if(allReagents.some(item => item.name === name)) return alert("该试剂已存在库中！");

        const { error } = await labClient.from('reagents').insert([{ name, location: loc, cas }]);
        if(error) {
            alert("添加失败: " + error.message);
        } else {
            // 注意：因为有了实时监听，这里甚至不需要手动 add 到 allReagents
            // 数据库成功后，监听会自动触发 fetchData
            toggleModal(false); 
            document.getElementById('newName').value = '';
            document.getElementById('newLoc').value = '';
            document.getElementById('newCas').value = '';
        }
    }

    async function deleteReagent(id) {
        if(confirm("确定要永久删除此试剂吗？")) {
            const { error } = await labClient.from('reagents').delete().eq('id', id);
            if(error) alert("删除失败: " + error.message);
            // 同样，删除成功后监听器会自动刷新列表
        }
    }

    window.onload = initSystem;
